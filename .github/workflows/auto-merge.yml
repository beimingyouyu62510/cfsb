name: æ›´æ–°ç¾å›½èŠ‚ç‚¹ # å·¥ä½œæµåç§°å·²æ›´æ–°

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *' # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  update-nodes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository # æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: Set up Python # è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # ä½¿ç”¨æœ€æ–°çš„ Python 3 ç‰ˆæœ¬

      - name: Install dependencies # å®‰è£…ä¾èµ–
        run: pip install requests pyyaml

      - name: Generate US Nodes YAML # ç”Ÿæˆç¾å›½èŠ‚ç‚¹ YAML æ–‡ä»¶
        run: |
          # ä»¥ä¸‹ Python è„šæœ¬å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
          # 1. å®šä¹‰è®¢é˜…é“¾æ¥åˆ—è¡¨ã€‚
          # 2. éå†æ¯ä¸ªé“¾æ¥ï¼Œä¸‹è½½å…¶å†…å®¹ã€‚
          # 3. è§£æ YAML å†…å®¹ï¼Œæå– 'proxies' åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ã€‚
          # 4. å°†æ‰€æœ‰èŠ‚ç‚¹åˆå¹¶åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ã€‚
          # 5. å°†åˆå¹¶åçš„èŠ‚ç‚¹å†™å…¥ 'providers/us.yaml' æ–‡ä»¶ã€‚
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»£ç†ï¼Œè„šæœ¬å°†å‹å¥½åœ°é€€å‡ºï¼Œä¸ä¼šå¯¼è‡´å·¥ä½œæµå¤±è´¥ã€‚
          python -c "
import requests
import yaml
import os
import sys

# è®¢é˜…é“¾æ¥åˆ—è¡¨
urls = [
    'https://nodesfree.github.io/clashnode/subscribe/clash.yml',
    'https://raw.githubusercontent.com/vxiaov/free_proxies/main/clash/clash.provider.yaml'
]

all_proxies = []

for url in urls:
    try:
        print(f'Fetching {url}...')
        response = requests.get(url, timeout=15) # è®¾ç½®è¯·æ±‚è¶…æ—¶ä¸º 15 ç§’
        response.raise_for_status() # å¦‚æœå“åº”çŠ¶æ€ç æ˜¯ 4xx æˆ– 5xxï¼Œåˆ™æŠ›å‡º HTTPError
        content = response.text

        data = yaml.safe_load(content)

        if 'proxies' in data and isinstance(data['proxies'], list):
            # å‡è®¾ YAML ä¸­æœ‰ä¸€ä¸ªåä¸º 'proxies' çš„åˆ—è¡¨ï¼ŒåŒ…å«ä»£ç†é…ç½®
            all_proxies.extend(data['proxies'])
            print(f'Found {len(data['proxies'])} proxies from {url}')
        else:
            print(f'Warning: No \'proxies\' key or non-list \'proxies\' found in {url}. Skipping.')

    except requests.exceptions.RequestException as e:
        print(f'Error fetching {url}: {e}', file=sys.stderr) # æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡º
    except yaml.YAMLError as e:
        print(f'Error parsing YAML from {url}: {e}', file=sys.stderr) # æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡º
    except Exception as e:
        print(f'An unexpected error occurred for {url}: {e}', file=sys.stderr) # æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡º

if not all_proxies:
    print('No proxies found after checking all URLs. Exiting without creating us.yaml.')
    sys.exit(0) # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»£ç†ï¼Œåˆ™ä»¥æˆåŠŸçŠ¶æ€é€€å‡ºï¼Œä¸åˆ›å»ºæ–‡ä»¶

# åˆ›å»º providers ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
output_dir = 'providers'
os.makedirs(output_dir, exist_ok=True)

# å†™å…¥ us.yaml æ–‡ä»¶
output_file = os.path.join(output_dir, 'us.yaml')
with open(output_file, 'w', encoding='utf-8') as f:
    yaml.dump({'proxies': all_proxies}, f, allow_unicode=True, sort_keys=False)

print(f'Successfully created {output_file} with {len(all_proxies)} proxies.')
"

      - name: Commit and push if there are changes # å¦‚æœæœ‰æ›´æ”¹ï¼Œæäº¤å¹¶æ¨é€
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status -s) ]]; then
            git add providers/us.yaml
            git commit -m "chore: ğŸš€ Update US nodes" # æäº¤ä¿¡æ¯å·²æ›´æ–°ï¼Œä¸å†æåŠæµ‹é€Ÿ
            git push
          else
            echo "No changes to commit." # æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          fi
