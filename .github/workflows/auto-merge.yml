name: Proxy Update

# å…³é”®1ï¼šæ˜¾å¼å†™æƒé™ï¼Œå¦åˆ™æ— æ³• push
permissions:
  contents: write
  actions: read

on:
  workflow_dispatch: {}           # æ‰‹åŠ¨è¿è¡ŒæŒ‰é’®
  schedule:
    - cron: "0 */6 * * *"         # æ¯6å°æ—¶

jobs:
  generate-and-commit-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # ç»Ÿä¸€ç”¨ bashï¼Œé¿å… [[ ... ]] åœ¨ sh ä¸‹æŠ¥é”™
    defaults:
      run:
        shell: bash

    steps:
      - name: 1) Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # è®© git diff æ›´ç¨³å®šä½¿ç”¨åŽ†å²
          # é»˜è®¤å°±ä¼šç”¨ GITHUB_TOKENï¼›æ— éœ€é¢å¤– token

      - name: 2) Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 3) Install dependencies
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install requests pyyaml aiohttp

      - name: 4) Prepare workspace
        run: |
          set -euxo pipefail
          mkdir -p providers logs
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la

      - name: 5) Run merge.py (or create empty providers)
        run: |
          set -euxo pipefail
          if [[ -f "merge.py" ]]; then
            echo "Found merge.py, running..."
            # ä¿ç•™æ—¥å¿—ï¼›ç”¨ UTC æ—¶é—´é¿å… runner æ—¶åŒºå·®å¼‚
            python merge.py 2>&1 | tee "logs/merge_$(date -u +%Y%m%d_%H%M%S).log"
          else
            echo "merge.py not found, write empty files."
            printf 'proxies: []\n' > providers/all.yaml
            printf 'proxies: []\n' > providers/us.yaml
          fi

      - name: 6) Validate YAML format
        run: |
          set -euxo pipefail
          python <<'PY'
import sys, yaml, pathlib
ok = True
for p in map(pathlib.Path, ['providers/all.yaml','providers/us.yaml']):
    if not p.exists():
        print(f'âŒ missing {p}')
        ok = False
        continue
    try:
        data = yaml.safe_load(p.read_text(encoding='utf-8')) or {}
        proxies = data.get('proxies')
        if proxies is None:
            raise ValueError("missing 'proxies' key")
        if not isinstance(proxies, list):
            raise ValueError("'proxies' must be a list")
        print(f'âœ… {p}: {len(proxies)} proxies')
    except Exception as e:
        print(f'âŒ {p}: {e}')
        ok = False
sys.exit(0 if ok else 1)
PY

      - name: 7) Detect changes
        id: diff
        run: |
          set -euxo pipefail
          # è®© git èƒ½å¯¹æœªè·Ÿè¸ªæ–‡ä»¶åš diff
          git add -N providers/all.yaml providers/us.yaml 2>/dev/null || true
          if git diff --quiet -- providers/all.yaml providers/us.yaml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff --stat -- providers/all.yaml providers/us.yaml || true
          fi

      - name: 8) Commit & push
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          # é¿å…â€œunsafe repositoryâ€
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add providers/all.yaml providers/us.yaml
          git commit -m "chore: update providers ($(date -u +'%F %T UTC'))"
          # è‹¥åˆ†æ”¯å—ä¿æŠ¤ï¼Œè¿™é‡Œä¼šå¤±è´¥ï¼›éœ€åœ¨ä»“åº“è®¾ç½®é‡Œæ”¾è¡Œ
          git push

      - name: 9) Summarize
        if: always()
        run: |
          echo "## ðŸš€ ä»£ç†èŠ‚ç‚¹æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          for f in providers/all.yaml providers/us.yaml; do
            if [[ -f "$f" ]]; then
              sz=$(du -h "$f" | cut -f1)
              cnt=$(grep -c '^- name:' "$f" || true)
              echo "- $f : $cnt æ¡ï¼ˆ$szï¼‰" >> $GITHUB_STEP_SUMMARY
            else
              echo "- $f : â›” æ–‡ä»¶ç¼ºå¤±" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: 10) Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merge-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
