name: Update US Nodes with Speed Test

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *' # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  update-nodes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run Python Script to Get All URLs
        id: get-urls
        run: |
          # å‡è®¾ä½ æœ‰ä¸€ä¸ª scripts/get_urls.py æ–‡ä»¶æ¥è·å–æ‰€æœ‰è®¢é˜…é“¾æ¥
          # è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥ç¡¬ç¼–ç  URL åˆ—è¡¨
          echo '{"urls": ["https://nodesfree.github.io/clashnode/subscribe/clash.yml", "https://raw.githubusercontent.com/vxiaov/free_proxies/main/clash/clash.provider.yaml"]}' > request_body.json

      - name: Call Railway API for speed test
        id: test-nodes
        run: |
          # å‘ä½ çš„ Railway åç«¯æœåŠ¡å‘é€è¯·æ±‚
          # æ›¿æ¢ <YOUR_RAILWAY_URL> ä¸ºä½ éƒ¨ç½²åœ¨ Railway ä¸Šçš„æœåŠ¡ URL
          API_URL="https://your-railway-app.railway.app/test-nodes"
          response=$(curl -s -X POST -H "Content-Type: application/json" -d @request_body.json $API_URL)
          echo "API Response: $response"
          echo "nodes_json=$response" >> $GITHUB_OUTPUT

      - name: Process response and create us.yaml
        run: |
          echo "Processing response..."
          
          # ä»ä¸Šä¸€æ­¥çš„è¾“å‡ºä¸­æå–JSON
          nodes_json='${{ fromJson(steps.test-nodes.outputs.nodes_json) }}'
          nodes_array=$(echo "$nodes_json" | jq '.nodes')

          if [ "$(echo "$nodes_array" | jq length)" -eq 0 ]; then
            echo "æ²¡æœ‰å¯ç”¨èŠ‚ç‚¹è¿”å›ï¼Œè·³è¿‡æ›´æ–°ã€‚"
            exit 0
          fi
          
          # æ„å»ºæœ€ç»ˆçš„YAMLæ–‡ä»¶
          echo "proxies:" > providers/us.yaml
          echo "$nodes_array" | jq -c '.[]' | while read -r line; do
            # jq --raw-output è½¬æ¢JSONä¸ºYAMLæ ¼å¼
            # è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„è½¬æ¢ï¼Œå¯èƒ½éœ€è¦æ›´å¤æ‚çš„è„šæœ¬æ¥æ­£ç¡®å¤„ç†YAML
            # æ¨èä½¿ç”¨ Python è„šæœ¬æ¥å®Œæˆ
            
            # ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ Python è„šæœ¬ï¼Œç”¨å®ƒæ¥å¤„ç†JSONåˆ°YAML
            python -c "
import json
import yaml
import sys
data = json.loads(sys.stdin.read())
with open('providers/us.yaml', 'a', encoding='utf-8') as f:
    yaml.dump(data, f, allow_unicode=True, sort_keys=False)
" <<< "$line"
          done
          
          echo "Successfully created providers/us.yaml"

      - name: Commit and push if there are changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status -s) ]]; then
            git add providers/us.yaml
            git commit -m "chore: ğŸš€ Update US nodes with speed test results"
            git push
          else
            echo "No changes to commit."
          fi
