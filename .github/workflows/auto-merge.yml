name: ä¼˜åŒ–ä»£ç†èŠ‚ç‚¹æ›´æ–°

on:
  schedule:
    - cron: '0 */6 * * *' # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼Œå¢žåŠ æ›´æ–°é¢‘çŽ‡
  workflow_dispatch: # å¯ç”¨æ‰‹åŠ¨è¿è¡ŒåŠŸèƒ½
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„æµ‹è¯•å‚æ•°ï¼‰'
        required: false
        default: 'true'
        type: boolean
      max_nodes:
        description: 'æœ€å¤§èŠ‚ç‚¹æ•°é‡é™åˆ¶'
        required: false
        default: '200'
        type: string

jobs:
  generate-and-commit-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 45 # å¢žåŠ è¶…æ—¶æ—¶é—´

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 # åªèŽ·å–æœ€æ–°æäº¤ï¼ŒåŠ é€Ÿclone

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # ä½¿ç”¨æ›´æ–°çš„Pythonç‰ˆæœ¬
          cache: 'pip' # å¯ç”¨pipç¼“å­˜

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests pyyaml aiohttp
          # å®‰è£…é¢å¤–çš„ä¾èµ–ç”¨äºŽæ›´å¥½çš„ç½‘ç»œå¤„ç†
          pip install --no-cache-dir aiodns cchardet

      - name: Create necessary directories
        run: |
          mkdir -p providers
          mkdir -p logs

      - name: Run the optimized script
        env:
          PYTHONUNBUFFERED: 1
          TEST_MODE: ${{ inputs.test_mode || 'true' }}
          MAX_NODES: ${{ inputs.max_nodes || '200' }}
        run: |
          echo "å¼€å§‹è¿è¡Œä¼˜åŒ–çš„ä»£ç†èŠ‚ç‚¹æ”¶é›†è„šæœ¬..."
          echo "æµ‹è¯•æ¨¡å¼: $TEST_MODE"
          echo "æœ€å¤§èŠ‚ç‚¹æ•°: $MAX_NODES"
          
          # è¿è¡Œè„šæœ¬å¹¶è®°å½•æ—¥å¿—
          python merge.py 2>&1 | tee logs/merge_$(date +%Y%m%d_%H%M%S).log
          
          echo "è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: Check results and file sizes
        id: check_results
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [[ -f "providers/all.yaml" ]]; then
            ALL_COUNT=$(grep -c "^- name:" providers/all.yaml || echo "0")
            ALL_SIZE=$(du -h providers/all.yaml | cut -f1)
            echo "all_count=$ALL_COUNT" >> $GITHUB_OUTPUT
            echo "all_size=$ALL_SIZE" >> $GITHUB_OUTPUT
            echo "âœ… providers/all.yaml: $ALL_COUNT èŠ‚ç‚¹, $ALL_SIZE"
          else
            echo "all_count=0" >> $GITHUB_OUTPUT
            echo "all_size=0" >> $GITHUB_OUTPUT
            echo "âŒ providers/all.yaml æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          if [[ -f "providers/us.yaml" ]]; then
            US_COUNT=$(grep -c "^- name:" providers/us.yaml || echo "0")
            US_SIZE=$(du -h providers/us.yaml | cut -f1)
            echo "us_count=$US_COUNT" >> $GITHUB_OUTPUT
            echo "us_size=$US_SIZE" >> $GITHUB_OUTPUT
            echo "âœ… providers/us.yaml: $US_COUNT èŠ‚ç‚¹, $US_SIZE"
          else
            echo "us_count=0" >> $GITHUB_OUTPUT
            echo "us_size=0" >> $GITHUB_OUTPUT
            echo "âŒ providers/us.yaml æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥è´¨é‡æŠ¥å‘Š
          if [[ -f "quality_report.json" ]]; then
            echo "âœ… è´¨é‡æŠ¥å‘Šå·²ç”Ÿæˆ"
          else
            echo "âš ï¸ è´¨é‡æŠ¥å‘Šæœªç”Ÿæˆ"
          fi

      - name: Validate YAML files
        run: |
          echo "éªŒè¯ç”Ÿæˆçš„YAMLæ–‡ä»¶æ ¼å¼..."
          
          if [[ -f "providers/all.yaml" ]]; then
            python -c "
            import yaml
            try:
                with open('providers/all.yaml', 'r', encoding='utf-8') as f:
                    data = yaml.safe_load(f)
                    print(f'âœ… all.yaml æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å« {len(data.get(\"proxies\", []))} ä¸ªèŠ‚ç‚¹')
            except Exception as e:
                print(f'âŒ all.yaml æ ¼å¼é”™è¯¯: {e}')
                exit(1)
            "
          fi
          
          if [[ -f "providers/us.yaml" ]]; then
            python -c "
            import yaml
            try:
                with open('providers/us.yaml', 'r', encoding='utf-8') as f:
                    data = yaml.safe_load(f)
                    print(f'âœ… us.yaml æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å« {len(data.get(\"proxies\", []))} ä¸ªèŠ‚ç‚¹')
            except Exception as e:
                print(f'âŒ us.yaml æ ¼å¼é”™è¯¯: {e}')
                exit(1)
            "
          fi

      - name: Check for meaningful changes
        id: changes
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®žè´¨æ€§å˜åŒ–
          if git diff --quiet providers/all.yaml providers/us.yaml 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶çš„å˜åŒ–"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶æœ‰å˜åŒ–"
            
            # æ˜¾ç¤ºå˜åŒ–æ¦‚è¦
            echo "å˜åŒ–æ¦‚è¦:"
            git diff --stat providers/all.yaml providers/us.yaml || true
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # é…ç½®git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ–‡ä»¶
          git add providers/all.yaml providers/us.yaml
          
          # å¦‚æžœè´¨é‡æŠ¥å‘Šå­˜åœ¨ï¼Œä¹Ÿä¸€å¹¶æäº¤
          if [[ -f "quality_report.json" ]]; then
            git add quality_report.json
          fi
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_MSG="feat: è‡ªåŠ¨æ›´æ–°ä»£ç†èŠ‚ç‚¹åˆ—è¡¨

          ðŸ“Š èŠ‚ç‚¹ç»Ÿè®¡:
          - å…¨é‡èŠ‚ç‚¹: ${{ steps.check_results.outputs.all_count }} ä¸ª (${{ steps.check_results.outputs.all_size }})
          - ç¾Žå›½èŠ‚ç‚¹: ${{ steps.check_results.outputs.us_count }} ä¸ª (${{ steps.check_results.outputs.us_size }})
          
          ðŸ• æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
          ðŸ¤– è‡ªåŠ¨åŒ–è¿è¡Œ: ${{ github.run_number }}"
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸš€ ä»£ç†èŠ‚ç‚¹æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–‡ä»¶ | èŠ‚ç‚¹æ•°é‡ | æ–‡ä»¶å¤§å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "providers/all.yaml" ]]; then
            echo "| providers/all.yaml | ${{ steps.check_results.outputs.all_count }} | ${{ steps.check_results.outputs.all_size }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| providers/all.yaml | 0 | - | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ -f "providers/us.yaml" ]]; then
            echo "| providers/us.yaml | ${{ steps.check_results.outputs.us_count }} | ${{ steps.check_results.outputs.us_size }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| providers/us.yaml | 0 | - | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æ›´æ–°çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ ä¼˜åŒ–ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ›´å®½æ¾çš„è´¨é‡æµ‹è¯•æ ‡å‡†" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä¿ç•™åŽŸå§‹èŠ‚ç‚¹åç§°" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ™ºèƒ½åŽ»é‡å’Œåˆ†æ‰¹å¤„ç†" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¢žå¼ºçš„é”™è¯¯å¤„ç†" >> $GITHUB_STEP_SUMMARY

      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merge-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
