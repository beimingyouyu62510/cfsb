name: Proxy Update

on:
  schedule:
    - cron: '0 */6 * * *' # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
  # å¯ç”¨æ‰‹åŠ¨è¿è¡ŒåŠŸèƒ½

jobs:
  generate-and-commit-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml aiohttp

      - name: Create directories
        run: |
          mkdir -p providers
          mkdir -p logs

      - name: List files for debugging
        run: |
          echo "å½“å‰ç›®å½•æ–‡ä»¶:"
          ls -la
          echo "merge.py å­˜åœ¨å—?"
          if [[ -f "merge.py" ]]; then
            echo "âœ… merge.py å­˜åœ¨"
            head -5 merge.py
          else
            echo "âŒ merge.py ä¸å­˜åœ¨"
          fi

      - name: Run the script
        run: |
          if [[ -f "merge.py" ]]; then
            echo "è¿è¡Œä¼˜åŒ–ç‰ˆmerge.py"
            python merge.py 2>&1 | tee logs/merge_$(date +%Y%m%d_%H%M%S).log
          else
            echo "merge.pyä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºé…ç½®æ–‡ä»¶"
            echo "proxies: []" > providers/all.yaml
            echo "proxies: []" > providers/us.yaml
          fi

      - name: Check results
        id: check_results
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          
          if [[ -f "providers/all.yaml" ]]; then
            ALL_COUNT=$(grep -c "^- name:" providers/all.yaml || echo "0")
            ALL_SIZE=$(du -h providers/all.yaml | cut -f1)
            echo "all_count=$ALL_COUNT" >> $GITHUB_OUTPUT
            echo "all_size=$ALL_SIZE" >> $GITHUB_OUTPUT
            echo "âœ… providers/all.yaml: $ALL_COUNT èŠ‚ç‚¹, $ALL_SIZE"
          else
            echo "all_count=0" >> $GITHUB_OUTPUT
            echo "all_size=0" >> $GITHUB_OUTPUT
            echo "âŒ providers/all.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            # åˆ›å»ºç©ºæ–‡ä»¶
            echo "proxies: []" > providers/all.yaml
          fi
          
          if [[ -f "providers/us.yaml" ]]; then
            US_COUNT=$(grep -c "^- name:" providers/us.yaml || echo "0")
            US_SIZE=$(du -h providers/us.yaml | cut -f1)
            echo "us_count=$US_COUNT" >> $GITHUB_OUTPUT
            echo "us_size=$US_SIZE" >> $GITHUB_OUTPUT
            echo "âœ… providers/us.yaml: $US_COUNT èŠ‚ç‚¹, $US_SIZE"
          else
            echo "us_count=0" >> $GITHUB_OUTPUT
            echo "us_size=0" >> $GITHUB_OUTPUT
            echo "âŒ providers/us.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            # åˆ›å»ºç©ºæ–‡ä»¶
            echo "proxies: []" > providers/us.yaml
          fi

      - name: Validate YAML files
        run: |
          echo "éªŒè¯YAMLæ–‡ä»¶æ ¼å¼..."
          python -c "
import yaml
import sys

files = ['providers/all.yaml', 'providers/us.yaml']
all_valid = True

for file in files:
    try:
        with open(file, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f)
            proxies = data.get('proxies', []) if data else []
            print(f'âœ… {file} æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å« {len(proxies)} ä¸ªèŠ‚ç‚¹')
    except Exception as e:
        print(f'âŒ {file} æ ¼å¼é”™è¯¯: {e}')
        all_valid = False

sys.exit(0 if all_valid else 1)
"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet providers/all.yaml providers/us.yaml 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶çš„å˜åŒ–"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶æœ‰å˜åŒ–"
            git diff --stat providers/all.yaml providers/us.yaml || true
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add providers/all.yaml providers/us.yaml
          
          # å¦‚æžœè´¨é‡æŠ¥å‘Šå­˜åœ¨ï¼Œä¹Ÿä¸€å¹¶æäº¤
          if [[ -f "quality_report.json" ]]; then
            git add quality_report.json
          fi
          
          COMMIT_MSG="feat: Auto update proxy list

ðŸ“Š èŠ‚ç‚¹ç»Ÿè®¡:
- å…¨é‡èŠ‚ç‚¹: ${{ steps.check_results.outputs.all_count }} ä¸ª
- ç¾Žå›½èŠ‚ç‚¹: ${{ steps.check_results.outputs.us_count }} ä¸ª

ðŸ• æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
ðŸ¤– è‡ªåŠ¨åŒ–è¿è¡Œ #${{ github.run_number }}"
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸš€ ä»£ç†èŠ‚ç‚¹æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ–‡ä»¶ | èŠ‚ç‚¹æ•°é‡ | æ–‡ä»¶å¤§å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "providers/all.yaml" ]]; then
            echo "| providers/all.yaml | ${{ steps.check_results.outputs.all_count }} | ${{ steps.check_results.outputs.all_size }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| providers/all.yaml | 0 | - | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ -f "providers/us.yaml" ]]; then
            echo "| providers/us.yaml | ${{ steps.check_results.outputs.us_count }} | ${{ steps.check_results.outputs.us_size }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| providers/us.yaml | 0 | - | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æ›´æ–°çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ è¿è¡Œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡Œç¼–å·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pythonç‰ˆæœ¬: $(python --version)" >> $GITHUB_STEP_SUMMARY

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merge-logs-${{ github.run_number }}
          path: logs/
          retention-days: 3
        continue-on-error: true
