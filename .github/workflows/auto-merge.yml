name: Proxy Update

on:
  schedule:
    - cron: '0 0 * * *' # 每天0点（UTC）定时运行
  workflow_dispatch: # 启用手动运行功能

jobs:
  generate-and-commit-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # 设置超时，防止无限期运行

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 用于提交更改，必须设置token
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # cache: 'pip' # 移除这一行，因为它导致了错误

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml aiohttp

      - name: Run the script
        run: python merge.py

      - name: Check for changes
        id: files_changed
        run: |
          # 检查providers/all.yaml和providers/us.yaml是否有内容更改
          if ! git diff --quiet providers/all.yaml providers/us.yaml; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Commit and push changes
        if: steps.files_changed.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add providers/all.yaml providers/us.yaml
          git commit -m "feat: Auto update proxy list"
          git push
