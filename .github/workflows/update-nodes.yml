import logging
import requests
import yaml
from pathlib import Path
from typing import List, Dict

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

REMOTE_URLS = [
    "https://example.com/nodes.yaml",  # æ›¿æ¢ä¸ºå®é™…çš„èŠ‚ç‚¹æº URL
]
TARGET_PROXY_GROUPS = ["ğŸš€ èŠ‚ç‚¹é€‰æ‹©", "â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "ğŸŒ å›½å¤–åª’ä½“", "ğŸ“² ç”µæŠ¥ä¿¡æ¯", "â“‚ï¸ å¾®è½¯æœåŠ¡", "ğŸ è‹¹æœæœåŠ¡", "ğŸ“¢ è°·æ­ŒFCM", "ğŸŸ æ¼ç½‘ä¹‹é±¼"]

def fetch_remote_yaml(url: str) -> Dict:
    """ä»è¿œç¨‹ URL è·å– YAML æ•°æ®"""
    try:
        logger.info(f"Fetching YAML from {url}")
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        return yaml.safe_load(response.text) or {}
    except requests.RequestException as e:
        logger.error(f"Failed to fetch {url}: {e}")
        return {}
    except yaml.YAMLError as e:
        logger.error(f"Invalid YAML from {url}: {e}")
        return {}

def load_local_yaml(file_path: Path) -> Dict:
    """åŠ è½½æœ¬åœ° YAML æ–‡ä»¶"""
    try:
        logger.info(f"Loading local YAML from {file_path}")
        with file_path.open('r', encoding='utf-8') as f:
            return yaml.safe_load(f) or {}
    except yaml.YAMLError as e:
        logger.error(f"Invalid YAML in {file_path}: {e}")
        return {}
    except FileNotFoundError:
        logger.warning(f"{file_path} not found, starting with empty config")
        return {}

def save_yaml(data: Dict, file_path: Path):
    """ä¿å­˜ YAML æ•°æ®åˆ°æ–‡ä»¶"""
    try:
        logger.info(f"Saving YAML to {file_path}")
        with file_path.open('w', encoding='utf-8') as f:
            yaml.safe_dump(data, f, allow_unicode=True, sort_keys=False)
    except Exception as e:
        logger.error(f"Failed to save {file_path}: {e}")
        raise

def filter_proxies(proxies: List[Dict]) -> List[Dict]:
    """è¿‡æ»¤ä»£ç†èŠ‚ç‚¹ï¼Œä»…ä¿ç•™ VLESS+WebSocket+TLS èŠ‚ç‚¹"""
    filtered = []
    for proxy in proxies:
        if (proxy.get('type') == 'vless' and
            proxy.get('network') == 'ws' and
            proxy.get('tls', False) and
            proxy.get('port') == 443):
            filtered.append(proxy)
        else:
            logger.warning(f"Skipping proxy {proxy.get('name', 'Unknown')}: not VLESS+WS+TLS or port != 443")
    return filtered

def update_proxy_groups(config: Dict, proxy_names: List[str]):
    """æ›´æ–° proxy-groupsï¼Œç¡®ä¿ä»…åŒ…å«æœ‰æ•ˆçš„ä»£ç†èŠ‚ç‚¹"""
    if 'proxy-groups' not in config:
        logger.error("No proxy-groups found in config")
        return
    
    for group in config['proxy-groups']:
        group_name = group.get('name')
        if group_name in TARGET_PROXY_GROUPS:
            # æ„å»ºæ–°çš„ proxies åˆ—è¡¨
            new_proxies = []
            if group_name == "ğŸ¯ å…¨çƒç›´è¿":
                new_proxies = ["DIRECT"]
            elif group_name == "ğŸ›‘ å…¨çƒæ‹¦æˆª":
                new_proxies = ["REJECT", "DIRECT"]
            elif group_name == "ğŸƒ åº”ç”¨å‡€åŒ–":
                new_proxies = ["REJECT", "DIRECT"]
            else:
                # æ·»åŠ æ ‡å‡†é€‰é¡¹å’Œæœ‰æ•ˆä»£ç†
                if group_name != "ğŸš€ èŠ‚ç‚¹é€‰æ‹©":
                    new_proxies.append("ğŸš€ èŠ‚ç‚¹é€‰æ‹©")
                if group_name != "â™»ï¸ è‡ªåŠ¨é€‰æ‹©":
                    new_proxies.append("â™»ï¸ è‡ªåŠ¨é€‰æ‹©")
                if group_name not in ["â“‚ï¸ å¾®è½¯æœåŠ¡", "ğŸ è‹¹æœæœåŠ¡"]:
                    new_proxies.append("ğŸ¯ å…¨çƒç›´è¿")
                new_proxies.extend(proxy_names)
            
            group['proxies'] = new_proxies
            logger.info(f"Updated proxy-group {group_name} with {len(new_proxies)} proxies")
        else:
            logger.warning(f"Skipping unknown proxy-group: {group_name}")

def main():
    """ä¸»å‡½æ•°ï¼šæ›´æ–° ch.yaml çš„ proxies å’Œ proxy-groups"""
    config_file = Path('ch.yaml')
    backup_file = Path('ch.yaml.bak')
    
    # å¤‡ä»½å½“å‰é…ç½®æ–‡ä»¶
    if config_file.exists():
        logger.info(f"Backing up {config_file} to {backup_file}")
        config_file.replace(backup_file)
    
    # åŠ è½½å½“å‰é…ç½®æ–‡ä»¶
    config = load_local_yaml(config_file)
    
    # è·å–è¿œç¨‹èŠ‚ç‚¹
    all_proxies = []
    for url in REMOTE_URLS:
        remote_data = fetch_remote_yaml(url)
        remote_proxies = remote_data.get('proxies', [])
        all_proxies.extend(filter_proxies(remote_proxies))
    
    if not all_proxies:
        logger.error("No valid proxies found from remote sources")
        if backup_file.exists():
            logger.info(f"Restoring backup from {backup_file}")
            backup_file.replace(config_file)
        return
    
    # æ›´æ–° proxies
    config['proxies'] = all_proxies
    proxy_names = [proxy['name'] for proxy in all_proxies]
    logger.info(f"Updated proxies: {', '.join(proxy_names)}")
    
    # æ›´æ–° proxy-groups
    update_proxy_groups(config, proxy_names)
    
    # ä¿å­˜æ›´æ–°åçš„é…ç½®æ–‡ä»¶
    save_yaml(config, config_file)
    
    # éªŒè¯æ›´æ–°åçš„ YAML
    try:
        with config_file.open('r', encoding='utf-8') as f:
            yaml.safe_load(f)
        logger.info(f"Successfully updated and validated {config_file}")
    except yaml.YAMLError as e:
        logger.error(f"Invalid YAML after update: {e}")
        if backup_file.exists():
            logger.info(f"Restoring backup from {backup_file}")
            backup_file.replace(config_file)
        raise

if __name__ == '__main__':
    main()
