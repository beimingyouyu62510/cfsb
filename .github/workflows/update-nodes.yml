name: Update Nodes

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œ
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æ˜ç¡®å£°æ˜éœ€è¦å†™å…¥ä»“åº“å†…å®¹çš„æƒé™

    steps:
      - name: Log Trigger Event
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "Running on branch: ${{ github.ref }}"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt # ä½¿ç”¨ requirements.txt æ–‡ä»¶å®‰è£…ä¾èµ–

      - name: Clean Old Backups
        run: |
          # æŸ¥æ‰¾å¹¶åˆ é™¤è¶…è¿‡ 7 å¤©çš„ ch.yaml.bak æ–‡ä»¶
          find . -name "ch.yaml.bak" -mtime +7 -delete
          echo "Cleaned backup files older than 7 days."

      - name: Validate ch.yaml Before Update
        run: |
          # éªŒè¯ ch.yaml æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœé”™è¯¯åˆ™é€€å‡ºå·¥ä½œæµ
          python -c "import yaml; yaml.safe_load(open('ch.yaml'))"
        # ç§»é™¤ continue-on-error: trueï¼Œå¦‚æœæ–‡ä»¶æ— æ•ˆåˆ™ç«‹å³ä¸­æ­¢

      - name: Configure Git
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…åœ¨æ¯ä¸ª Git æ“ä½œä¸­é‡å¤
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Test Proxy Connectivity
        run: python test_proxies.py
        env:
          LOG_LEVEL: DEBUG # è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º DEBUG
        continue-on-error: true  # ä»£ç†æµ‹è¯•å¤±è´¥æ—¶å…è®¸å·¥ä½œæµç»§ç»­

      - name: Run update_nodes.py
        run: python update_nodes.py
        env:
          LOG_LEVEL: DEBUG # è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º DEBUG

      - name: Validate ch.yaml After Update
        run: |
          # æ›´æ–°åå†æ¬¡éªŒè¯ ch.yaml æ ¼å¼ï¼Œå¦‚æœé”™è¯¯åˆ™é€€å‡ºå·¥ä½œæµ
          python -c "import yaml; yaml.safe_load(open('ch.yaml'))" || exit 1

      - name: Check for Changes and Commit
        id: commit_changes # æ·»åŠ  id ä»¥ä¾¿åœ¨åç»­æ­¥éª¤ä¸­å¼•ç”¨
        run: |
          git add ch.yaml # æš‚å­˜ ch.yaml
          git diff --cached ch.yaml > diff.txt # æ¯”è¾ƒæš‚å­˜åŒºå’Œ HEAD çš„å·®å¼‚
          if [ -s diff.txt ]; then # å¦‚æœ diff.txt ä¸ä¸ºç©ºï¼ˆæœ‰å˜åŒ–ï¼‰
            echo "Changes detected in ch.yaml:"
            cat diff.txt
            git commit -m "ğŸ¤– Update proxies and load-balance group" # æäº¤æ›´æ”¹
            echo "changes_made=true" >> $GITHUB_OUTPUT # è®¾ç½®è¾“å‡ºå˜é‡
          else
            echo "No changes detected in ch.yaml"
            echo "changes_made=false" >> $GITHUB_OUTPUT # è®¾ç½®è¾“å‡ºå˜é‡
          fi

      - name: Push ch.yaml Changes
        if: steps.commit_changes.outputs.changes_made == 'true' # åªæœ‰å½“æœ‰å˜åŒ–æ—¶æ‰æ¨é€
        run: git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update and Push Log
        if: always() # æ€»æ˜¯è¿è¡Œï¼Œæ— è®ºå‰é¢æ˜¯å¦å¤±è´¥
        run: |
          # å°†å·¥ä½œæµå®ŒæˆçŠ¶æ€å’Œ ch.yaml æ˜¯å¦æ›´æ–°çš„ä¿¡æ¯è¿½åŠ åˆ° update.log
          echo "$(date): Workflow completed, ch.yaml updated: ${{ steps.commit_changes.outputs.changes_made }}" >> update.log
          git add update.log # æš‚å­˜ update.log
          git commit -m "Update workflow log" --allow-empty || true # æäº¤æ—¥å¿—ï¼Œå…è®¸ç©ºæäº¤
          git push # æ¨é€æ—¥å¿—æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
